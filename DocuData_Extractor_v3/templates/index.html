<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Building Code Processor</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .container {
            background-color: #f9f9f9;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .tab {
            overflow: hidden;
            border: 1px solid #ccc;
            background-color: #f1f1f1;
            border-radius: 4px 4px 0 0;
        }
        .tab button {
            background-color: inherit;
            float: left;
            border: none;
            outline: none;
            cursor: pointer;
            padding: 14px 16px;
            transition: 0.3s;
            font-size: 16px;
        }
        .tab button:hover {
            background-color: #ddd;
        }
        .tab button.active {
            background-color: #ccc;
        }
        .tabcontent {
            display: none;
            padding: 20px;
            border: 1px solid #ccc;
            border-top: none;
            border-radius: 0 0 4px 4px;
            animation: fadeEffect 1s;
        }
        #gridfs-file-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            margin-bottom: 15px;
        }
        .gridfs-file {
            padding: 8px;
            margin: 4px 0;
            background-color: #f5f5f5;
            border-radius: 4px;
            cursor: pointer;
        }
        .gridfs-file:hover {
            background-color: #e9e9e9;
        }
        .gridfs-file.selected {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
        }
        input[type="text"], select {
            width: 100%;
            padding: 8px;
            margin: 8px 0;
            display: inline-block;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }
        input[type="file"] {
            margin: 8px 0;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 15px;
            margin: 8px 0;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #45a049;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .hidden {
            display: none;
        }
        .loading {
            text-align: center;
            padding: 20px;
        }
        .error {
            color: #721c24;
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        @keyframes fadeEffect {
            from {opacity: 0;}
            to {opacity: 1;}
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Building Code Processor</h1>
        <p>Select a building code JSON file from MongoDB or upload a new one, then specify a location to find applicable codes.</p>
        
        <div class="tab">
            <button class="tablinks active" onclick="openTab(event, 'GridFSTab')">Select from MongoDB</button>
            <button class="tablinks" onclick="openTab(event, 'UploadTab')">Upload File</button>
        </div>
        
        <div id="GridFSTab" class="tabcontent" style="display: block;">
            <h2>Select File from MongoDB</h2>
            <div class="form-group">
                <button id="refresh-gridfs" onclick="loadGridFSFiles()">Refresh File List</button>
                <div id="gridfs-file-list" class="loading">
                    <p>Loading files from MongoDB...</p>
                </div>
            </div>
            <form id="gridfs-form" class="hidden">
                <input type="hidden" id="gridfs-id" name="gridfs_id">
                <input type="hidden" id="session-id" name="session_id">
                <div class="form-group">
                    <label for="gridfs-city">City:</label>
                    <input type="text" id="gridfs-city" name="city" required>
                </div>
                <div class="form-group">
                    <label for="gridfs-state">State/Region:</label>
                    <input type="text" id="gridfs-state" name="state" required>
                </div>
                <div class="form-group">
                    <label for="gridfs-country">Country:</label>
                    <input type="text" id="gridfs-country" name="country" required>
                </div>
                <div class="form-group">
                    <label for="gridfs-keyword">Keyword (optional):</label>
                    <input type="text" id="gridfs-keyword" name="keyword">
                </div>
                <button type="submit">Process Selected File</button>
            </form>
        </div>
        
        <div id="UploadTab" class="tabcontent">
            <h2>Upload Building Code File</h2>
            <div class="form-group">
                <button id="upload-to-mongodb" onclick="toggleUploadToMongoDB()">Upload to MongoDB first</button>
                <div id="upload-mongodb-form" class="hidden">
                    <input type="file" id="mongodb-file" name="file" accept=".json">
                    <button onclick="uploadToMongoDB()">Upload</button>
                    <div id="upload-status"></div>
                </div>
            </div>
            <form id="upload-form" enctype="multipart/form-data">
                <div class="form-group">
                    <label for="file">JSON File:</label>
                    <input type="file" id="file" name="file" accept=".json" required>
                </div>
                <div class="form-group">
                    <label for="city">City:</label>
                    <input type="text" id="city" name="city" required>
                </div>
                <div class="form-group">
                    <label for="state">State/Region:</label>
                    <input type="text" id="state" name="state" required>
                </div>
                <div class="form-group">
                    <label for="country">Country:</label>
                    <input type="text" id="country" name="country" required>
                </div>
                <div class="form-group">
                    <label for="keyword">Keyword (optional):</label>
                    <input type="text" id="keyword" name="keyword">
                </div>
                <button type="submit">Process File</button>
            </form>
        </div>
        
        <div id="results" class="hidden">
            <h2>Results</h2>
            <div id="results-content"></div>
        </div>
    </div>

    <script>
        // Tab switching functionality
        function openTab(evt, tabName) {
            var i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tabcontent");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }
            tablinks = document.getElementsByClassName("tablinks");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }
            document.getElementById(tabName).style.display = "block";
            evt.currentTarget.className += " active";
            
            // If selecting MongoDB tab, load files
            if (tabName === "GridFSTab") {
                loadGridFSFiles();
            }
        }
        
        // Toggle MongoDB upload form
        function toggleUploadToMongoDB() {
            const form = document.getElementById('upload-mongodb-form');
            form.classList.toggle('hidden');
        }
        
        // Upload file to MongoDB
        async function uploadToMongoDB() {
            const fileInput = document.getElementById('mongodb-file');
            const statusDiv = document.getElementById('upload-status');
            
            if (!fileInput.files || fileInput.files.length === 0) {
                statusDiv.innerHTML = '<p class="error">Please select a file to upload</p>';
                return;
            }
            
            const file = fileInput.files[0];
            const formData = new FormData();
            formData.append('file', file);
            
            statusDiv.innerHTML = '<p>Uploading...</p>';
            
            try {
                const response = await fetch('/api/upload-to-gridfs', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                if (response.ok) {
                    statusDiv.innerHTML = `<p>File "${data.filename}" uploaded successfully to MongoDB!</p>`;
                    // Refresh the file list in the GridFS tab
                    loadGridFSFiles();
                } else {
                    statusDiv.innerHTML = `<p class="error">Upload failed: ${data.detail}</p>`;
                }
            } catch (error) {
                statusDiv.innerHTML = `<p class="error">Upload failed: ${error.message}</p>`;
            }
        }
        
        // Load GridFS files
        async function loadGridFSFiles() {
            const fileList = document.getElementById('gridfs-file-list');
            fileList.innerHTML = '<p class="loading">Loading files from MongoDB...</p>';
            fileList.className = 'loading';
            
            try {
                const response = await fetch('/api/gridfs-files');
                const data = await response.json();
                
                fileList.className = '';
                
                if (data.files && data.files.length > 0) {
                    fileList.innerHTML = '';
                    data.files.forEach(file => {
                        const fileElement = document.createElement('div');
                        fileElement.className = 'gridfs-file';
                        fileElement.dataset.id = file.id;
                        fileElement.innerHTML = `
                            <strong>${file.filename}</strong><br>
                            <small>Uploaded: ${new Date(file.upload_date).toLocaleString()}</small><br>
                            <small>Size: ${(file.length / 1024).toFixed(2)} KB</small>
                        `;
                        fileElement.addEventListener('click', () => selectGridFSFile(file.id));
                        fileList.appendChild(fileElement);
                    });
                } else {
                    fileList.innerHTML = '<p>No files found in MongoDB GridFS storage</p><p>Please upload files using the "Upload File" tab first.</p>';
                }
            } catch (error) {
                fileList.innerHTML = `<p class="error">Error loading files: ${error.message}</p>`;
            }
        }
        
        // Select a GridFS file
        async function selectGridFSFile(fileId) {
            // Clear previous selection
            document.querySelectorAll('.gridfs-file').forEach(el => {
                el.classList.remove('selected');
            });
            
            // Mark as selected
            const selectedFile = document.querySelector(`.gridfs-file[data-id="${fileId}"]`);
            if (selectedFile) {
                selectedFile.classList.add('selected');
            }
            
            // Set the file ID in hidden field
            document.getElementById('gridfs-id').value = fileId;
            
            // Create session with GridFS selection
            try {
                const response = await fetch('/api/select-file-source', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        source_type: 'gridfs',
                        gridfs_id: fileId
                    }),
                });
                
                const data = await response.json();
                document.getElementById('session-id').value = data.session_id;
                
                // Show the form to collect location data
                document.getElementById('gridfs-form').classList.remove('hidden');
            } catch (error) {
                alert(`Error selecting file: ${error.message}`);
            }
        }
        
        // Handle gridfs form submission
        document.getElementById('gridfs-form').addEventListener('submit', async function(event) {
            event.preventDefault();
            
            const formData = new FormData(this);
            
            try {
                const response = await fetch('/api/list-codes', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                displayResults(data);
            } catch (error) {
                alert(`Error processing file: ${error.message}`);
            }
        });
        
        // Handle upload form submission
        document.getElementById('upload-form').addEventListener('submit', async function(event) {
            event.preventDefault();
            
            const formData = new FormData(this);
            
            try {
                // Create a session for upload
                const sessionResponse = await fetch('/api/select-file-source', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        source_type: 'upload'
                    }),
                });
                
                const sessionData = await sessionResponse.json();
                formData.append('session_id', sessionData.session_id);
                
                // List codes with the uploaded file
                const response = await fetch('/api/list-codes', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                displayResults(data);
            } catch (error) {
                alert(`Error processing file: ${error.message}`);
            }
        });
        
        // Display results
        function displayResults(data) {
            const resultsContent = document.getElementById('results-content');
            
            if (data.codes && data.codes.length > 0) {
                let html = `
                    <p>Found ${data.codes.length} codes for location: ${data.location}</p>
                    <p>Select codes to process:</p>
                    <form id="code-selection-form">
                        <input type="hidden" name="session_id" value="${data.session_id}">
                        <div class="form-group">
                `;
                
                data.codes.forEach((code, index) => {
                    html += `
                        <div>
                            <input type="checkbox" id="code-${code.index}" name="selected_codes" value="${code.index}">
                            <label for="code-${code.index}">${code.name} (v${code.version}, ${code.date})</label>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                        <button type="submit">Process Selected Codes</button>
                    </form>
                `;
                
                resultsContent.innerHTML = html;
                document.getElementById('results').classList.remove('hidden');
                
                // Handle code selection form
                document.getElementById('code-selection-form').addEventListener('submit', async function(event) {
                    event.preventDefault();
                    
                    const selectedCodes = Array.from(
                        this.querySelectorAll('input[name="selected_codes"]:checked')
                    ).map(checkbox => parseInt(checkbox.value));
                    
                    if (selectedCodes.length === 0) {
                        alert('Please select at least one code to process');
                        return;
                    }
                    
                    try {
                        const response = await fetch('/api/process-codes', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                session_id: data.session_id,
                                selected_indices: selectedCodes
                            }),
                        });
                        
                        const processData = await response.json();
                        displayProcessResults(processData);
                    } catch (error) {
                        alert(`Error processing codes: ${error.message}`);
                    }
                });
            } else {
                resultsContent.innerHTML = `<p>No codes found for location: ${data.location}</p>`;
                document.getElementById('results').classList.remove('hidden');
            }
        }
        
        // Display process results
        function displayProcessResults(data) {
            const resultsContent = document.getElementById('results-content');
            
            let html = `
                <h3>Report Preview</h3>
                <div>${data.report_preview_html}</div>
                <p><a href="/api/report/${data.session_id}" target="_blank">View Full Report</a></p>
                
                <h3>Query the Building Codes</h3>
                <form id="query-form">
                    <input type="hidden" name="session_id" value="${data.session_id}">
                    <div class="form-group">
                        <label for="query">Enter your question:</label>
                        <input type="text" id="query" name="query" required placeholder="e.g., What are the requirements for fire exits?">
                    </div>
                    <button type="submit">Submit Query</button>
                </form>
                <div id="query-results" class="hidden"></div>
            `;
            
            resultsContent.innerHTML = html;
            
            // Handle query form
            document.getElementById('query-form').addEventListener('submit', async function(event) {
                event.preventDefault();
                
                const queryInput = document.getElementById('query');
                const queryResults = document.getElementById('query-results');
                
                try {
                    const response = await fetch('/api/query', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            session_id: data.session_id,
                            query: queryInput.value
                        }),
                    });
                    
                    const queryData = await response.json();
                    queryResults.innerHTML = `
                        <h3>Answer</h3>
                        <div>${queryData.answer_html}</div>
                    `;
                    queryResults.classList.remove('hidden');
                } catch (error) {
                    alert(`Error processing query: ${error.message}`);
                }
            });
        }
        
        // Load GridFS files on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadGridFSFiles();
        });
    </script>
</body>
</html>
